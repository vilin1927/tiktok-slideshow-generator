<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - API Keys</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="text-gray-100">
    <div x-data="adminApp()" class="container mx-auto px-4 py-8 max-w-lg">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2">Admin Panel</h1>
            <p class="text-gray-400">API Key Management</p>
        </div>

        <!-- Login Form -->
        <div x-show="!isAuthenticated" class="bg-gray-800/50 backdrop-blur rounded-xl p-6 shadow-xl">
            <h2 class="text-xl font-semibold mb-4">Login</h2>

            <form @submit.prevent="login">
                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-medium mb-2">Password</label>
                    <input
                        type="password"
                        x-model="password"
                        placeholder="Enter admin password"
                        class="w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent text-white"
                        :disabled="loading"
                    >
                </div>

                <div x-show="loginError" class="mb-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-400 text-sm">
                    <span x-text="loginError"></span>
                </div>

                <button
                    type="submit"
                    class="w-full py-3 bg-gradient-to-r from-pink-500 to-purple-600 rounded-lg font-semibold hover:from-pink-600 hover:to-purple-700 transition-all disabled:opacity-50"
                    :disabled="loading || !password"
                >
                    <span x-show="!loading">Login</span>
                    <span x-show="loading">Authenticating...</span>
                </button>
            </form>
        </div>

        <!-- API Keys Management -->
        <div x-show="isAuthenticated" x-cloak>
            <!-- Header with logout -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold">API Keys</h2>
                <button
                    @click="logout"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors"
                >
                    Logout
                </button>
            </div>

            <!-- Success/Error Messages -->
            <div x-show="message" x-transition class="mb-4 p-3 rounded-lg text-sm"
                 :class="messageType === 'success' ? 'bg-green-500/20 border border-green-500/50 text-green-400' : 'bg-red-500/20 border border-red-500/50 text-red-400'">
                <span x-text="message"></span>
            </div>

            <!-- Keys Form -->
            <div class="bg-gray-800/50 backdrop-blur rounded-xl p-6 shadow-xl space-y-6">
                <!-- Gemini API Key -->
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">
                        Gemini API Key
                        <span x-show="keys.GEMINI_API_KEY?.is_set" class="text-green-400 text-xs ml-2">(Set)</span>
                        <span x-show="!keys.GEMINI_API_KEY?.is_set" class="text-yellow-400 text-xs ml-2">(Not set)</span>
                    </label>
                    <div class="text-xs text-gray-500 mb-2" x-show="keys.GEMINI_API_KEY?.masked">
                        Current: <span x-text="keys.GEMINI_API_KEY?.masked"></span>
                    </div>
                    <input
                        type="password"
                        x-model="newKeys.GEMINI_API_KEY"
                        placeholder="Enter new Gemini API key"
                        class="w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent text-white"
                    >
                </div>

                <!-- RapidAPI Key -->
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">
                        RapidAPI Key
                        <span x-show="keys.RAPIDAPI_KEY?.is_set" class="text-green-400 text-xs ml-2">(Set)</span>
                        <span x-show="!keys.RAPIDAPI_KEY?.is_set" class="text-yellow-400 text-xs ml-2">(Not set)</span>
                    </label>
                    <div class="text-xs text-gray-500 mb-2" x-show="keys.RAPIDAPI_KEY?.masked">
                        Current: <span x-text="keys.RAPIDAPI_KEY?.masked"></span>
                    </div>
                    <input
                        type="password"
                        x-model="newKeys.RAPIDAPI_KEY"
                        placeholder="Enter new RapidAPI key"
                        class="w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent text-white"
                    >
                </div>

                <!-- Save Button -->
                <button
                    @click="saveKeys"
                    class="w-full py-3 bg-gradient-to-r from-pink-500 to-purple-600 rounded-lg font-semibold hover:from-pink-600 hover:to-purple-700 transition-all disabled:opacity-50"
                    :disabled="saving || (!newKeys.GEMINI_API_KEY && !newKeys.RAPIDAPI_KEY)"
                >
                    <span x-show="!saving">Save Changes</span>
                    <span x-show="saving">Saving...</span>
                </button>

                <p class="text-xs text-gray-500 text-center">
                    Only filled fields will be updated. Leave empty to keep current value.
                </p>
            </div>

            <!-- Job Queue Section -->
            <div class="mt-8 bg-gray-800/50 backdrop-blur rounded-xl p-6 shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Job Queue</h2>
                    <button @click="refreshJobs" class="text-sm px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded">
                        Refresh
                    </button>
                </div>

                <!-- Queue Stats -->
                <div class="grid grid-cols-4 gap-2 mb-4 text-center text-xs">
                    <div class="bg-yellow-500/20 rounded p-2">
                        <div class="text-yellow-400 font-bold" x-text="queueStats.pending">0</div>
                        <div class="text-gray-400">Pending</div>
                    </div>
                    <div class="bg-blue-500/20 rounded p-2">
                        <div class="text-blue-400 font-bold" x-text="queueStats.processing">0</div>
                        <div class="text-gray-400">Processing</div>
                    </div>
                    <div class="bg-green-500/20 rounded p-2">
                        <div class="text-green-400 font-bold" x-text="queueStats.completed">0</div>
                        <div class="text-gray-400">Completed</div>
                    </div>
                    <div class="bg-red-500/20 rounded p-2">
                        <div class="text-red-400 font-bold" x-text="queueStats.failed">0</div>
                        <div class="text-gray-400">Failed</div>
                    </div>
                </div>

                <!-- Jobs List -->
                <div class="space-y-2 max-h-64 overflow-y-auto">
                    <template x-for="job in jobs" :key="job.id">
                        <div class="bg-gray-700/50 rounded p-3 text-sm">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="font-mono text-xs text-gray-400" x-text="job.id.substring(0, 8)"></span>
                                    <span class="ml-2" x-text="job.folder_name || 'Unnamed'"></span>
                                </div>
                                <span class="px-2 py-0.5 rounded text-xs"
                                      :class="{
                                          'bg-yellow-500/30 text-yellow-400': job.status === 'pending',
                                          'bg-blue-500/30 text-blue-400': job.status === 'processing',
                                          'bg-green-500/30 text-green-400': job.status === 'completed',
                                          'bg-red-500/30 text-red-400': job.status === 'failed'
                                      }"
                                      x-text="job.status">
                                </span>
                            </div>
                            <div x-show="job.drive_url" class="mt-1">
                                <a :href="job.drive_url" target="_blank" class="text-xs text-pink-400 hover:text-pink-300">
                                    View in Drive &rarr;
                                </a>
                            </div>
                            <div x-show="job.error_message" class="mt-1 text-xs text-red-400" x-text="job.error_message"></div>
                        </div>
                    </template>
                    <div x-show="jobs.length === 0" class="text-center text-gray-500 py-4">
                        No jobs found
                    </div>
                </div>
            </div>

            <!-- Back to App Link -->
            <div class="mt-6 text-center">
                <a href="/" class="text-pink-400 hover:text-pink-300 text-sm">
                    &larr; Back to Generator
                </a>
            </div>
        </div>
    </div>

    <script>
        // API Base URL - change for production
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5001'
            : '';

        function adminApp() {
            return {
                // Auth state
                isAuthenticated: false,
                password: '',
                token: '',
                loginError: '',
                loading: false,

                // Keys state
                keys: {},
                newKeys: {
                    GEMINI_API_KEY: '',
                    RAPIDAPI_KEY: ''
                },
                saving: false,
                message: '',
                messageType: 'success',

                // Job queue state
                jobs: [],
                queueStats: { pending: 0, processing: 0, completed: 0, failed: 0 },

                init() {
                    // Check for stored token
                    const storedToken = localStorage.getItem('adminToken');
                    if (storedToken) {
                        this.token = storedToken;
                        this.verifyToken();
                    }
                },

                async verifyToken() {
                    try {
                        const res = await fetch(`${API_BASE}/api/admin/verify`, {
                            headers: { 'X-Admin-Token': this.token }
                        });
                        if (res.ok) {
                            this.isAuthenticated = true;
                            this.fetchKeys();
                            this.refreshJobs();
                        } else {
                            this.clearToken();
                        }
                    } catch (e) {
                        this.clearToken();
                    }
                },

                clearToken() {
                    this.token = '';
                    this.isAuthenticated = false;
                    localStorage.removeItem('adminToken');
                },

                async login() {
                    this.loading = true;
                    this.loginError = '';

                    try {
                        const res = await fetch(`${API_BASE}/api/admin/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ password: this.password })
                        });

                        const data = await res.json();

                        if (res.ok) {
                            this.token = data.token;
                            this.isAuthenticated = true;
                            localStorage.setItem('adminToken', data.token);
                            this.password = '';
                            this.fetchKeys();
                            this.refreshJobs();
                        } else {
                            this.loginError = data.error || 'Login failed';
                        }
                    } catch (e) {
                        this.loginError = 'Connection error. Is the server running?';
                    } finally {
                        this.loading = false;
                    }
                },

                async logout() {
                    try {
                        await fetch(`${API_BASE}/api/admin/logout`, {
                            method: 'POST',
                            headers: { 'X-Admin-Token': this.token }
                        });
                    } catch (e) {
                        // Ignore errors
                    }
                    this.clearToken();
                    this.keys = {};
                    this.newKeys = { GEMINI_API_KEY: '', RAPIDAPI_KEY: '' };
                },

                async fetchKeys() {
                    try {
                        const res = await fetch(`${API_BASE}/api/admin/keys`, {
                            headers: { 'X-Admin-Token': this.token }
                        });

                        if (res.ok) {
                            const data = await res.json();
                            this.keys = data.keys;
                        } else if (res.status === 401) {
                            this.clearToken();
                        }
                    } catch (e) {
                        console.error('Failed to fetch keys:', e);
                    }
                },

                async saveKeys() {
                    this.saving = true;
                    this.message = '';

                    // Only include non-empty keys
                    const payload = {};
                    if (this.newKeys.GEMINI_API_KEY.trim()) {
                        payload.GEMINI_API_KEY = this.newKeys.GEMINI_API_KEY.trim();
                    }
                    if (this.newKeys.RAPIDAPI_KEY.trim()) {
                        payload.RAPIDAPI_KEY = this.newKeys.RAPIDAPI_KEY.trim();
                    }

                    try {
                        const res = await fetch(`${API_BASE}/api/admin/keys`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Admin-Token': this.token
                            },
                            body: JSON.stringify(payload)
                        });

                        const data = await res.json();

                        if (res.ok) {
                            this.messageType = 'success';
                            this.message = data.message || 'Keys updated successfully';
                            this.newKeys = { GEMINI_API_KEY: '', RAPIDAPI_KEY: '' };
                            this.fetchKeys(); // Refresh masked values
                        } else if (res.status === 401) {
                            this.clearToken();
                        } else {
                            this.messageType = 'error';
                            this.message = data.error || data.message || 'Update failed';
                        }
                    } catch (e) {
                        this.messageType = 'error';
                        this.message = 'Connection error';
                    } finally {
                        this.saving = false;
                        // Clear message after 5 seconds
                        setTimeout(() => { this.message = ''; }, 5000);
                    }
                },

                async refreshJobs() {
                    try {
                        const res = await fetch(`${API_BASE}/api/jobs?limit=20`);
                        if (res.ok) {
                            const data = await res.json();
                            this.jobs = data.jobs || [];
                            // Calculate stats
                            this.queueStats = {
                                pending: this.jobs.filter(j => j.status === 'pending').length,
                                processing: this.jobs.filter(j => j.status === 'processing').length,
                                completed: this.jobs.filter(j => j.status === 'completed').length,
                                failed: this.jobs.filter(j => j.status === 'failed').length
                            };
                        }
                    } catch (e) {
                        console.error('Failed to fetch jobs:', e);
                    }
                }
            };
        }
    </script>
</body>
</html>
